(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{375:function(t,a,s){"use strict";s.r(a);var r=s(7),e=Object(r.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"nginx-反向代理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-反向代理"}},[t._v("#")]),t._v(" Nginx 反向代理")]),t._v(" "),s("h2",{attrs:{id:"代理目录匹配-location"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#代理目录匹配-location"}},[t._v("#")]),t._v(" 代理目录匹配 location")]),t._v(" "),s("p",[t._v("常用匹配规则如下：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("匹配所有根目录")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v('字符串匹配,  表示匹配所有"/static"开头的目录')]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("static\n")])])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("~")]),t._v("  匹配符合表达式目录比如代理目录中存在“static/(js|images)”的目录")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("static"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("js"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("images"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("~*")]),t._v("  加上 "),s("code",[t._v("*")]),t._v("  表示不区分大小写")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("static"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("js"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("images"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("=")]),t._v(' 表示精确匹配,  只有"/index"路径才会被代理，"/index/test"将不会被代理')]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v("\n")])])])])]),t._v(" "),s("blockquote",[s("p",[t._v("当然还有"),s("code",[t._v("!")]),t._v("、"),s("code",[t._v("^")]),t._v("匹配，用的比较少，这里不做说明")])]),t._v(" "),s("h2",{attrs:{id:"设置代理请求头-proxy-set-header"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#设置代理请求头-proxy-set-header"}},[t._v("#")]),t._v(" 设置代理请求头 proxy_set_header")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("设置代理请求服务器请求头")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[t._v("hostproxy_set_header Host "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("设置代理请求的 ip 地址")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Forwarded"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Ip "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("设置代理请求自定义数据")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" test test\n")])])])])]),t._v(" "),s("blockquote",[s("p",[t._v("这里还有很多数据，不一一说明")])]),t._v(" "),s("h2",{attrs:{id:"请求代理服务器-proxy-pass"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#请求代理服务器-proxy-pass"}},[t._v("#")]),t._v(" 请求代理服务器 proxy_pass")]),t._v(" "),s("ul",[s("li",[s("p",[t._v('从 "127.0.0.1" 这台服务器收发数据，当然也可以直接写域名')]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("从服务端机器 data 目录收发数据")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("81")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("动态配置数据:")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$scheme")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_uri")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$args")]),t._v("\n")])])]),s("ul",[s("li",[s("code",[t._v("$scheme")]),t._v("表示用户请求是 http 还是 https,")]),t._v(" "),s("li",[s("code",[t._v("$host")]),t._v(" 表示客户端请求头 host,")]),t._v(" "),s("li",[s("code",[t._v("$args")]),t._v(" 表示客户端请求参数")])])])]),t._v(" "),s("h2",{attrs:{id:"url-重定向规则-rewrite"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#url-重定向规则-rewrite"}},[t._v("#")]),t._v(" url 重定向规则 rewrite")]),t._v(" "),s("p",[t._v("包含 3 个参数：")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v("  匹配规则   重定向规则   重定向类型"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("用法示例：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("/a.html  的时候，url 重定向路径  /b.html  中")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html last"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("break  与  last 的区别是，当存在多条 rewrite 规则时 last 会继续往下匹配，break 不会继续往下匹配，而是将匹配到的重定向路径当做最终路径")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("当然重定向规则也是可以写正则表达式的   例如：\n/static/images/a.png => /local/images/a.png")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("static"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("images"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("images"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("redirect  表示 302 重定向")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html redirect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("permanent  表示 301 重定向")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html permanent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("301 重定向表示永久性重定向，对于 SEO 相较 302 来说比较友好，这里不做过多说明。")])])]),t._v(" "),s("h2",{attrs:{id:"nginx-反向代理-location-配置匹配规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-反向代理-location-配置匹配规则"}},[t._v("#")]),t._v(" nginx 反向代理 location 配置匹配规则")]),t._v(" "),s("p",[t._v("当我们访问 "),s("a",{attrs:{href:"*"}},[t._v("http://proxy_location/my_path")]),t._v(" 时:")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("location")]),t._v(" "),s("th",[t._v("proxy_pass")]),t._v(" "),s("th",[t._v("代理路径")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("/proxy_location/")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server")])]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/proxy_location/my_path")])])]),t._v(" "),s("tr",[s("td",[t._v("/proxy_location/")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/")])]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/my_path")])])]),t._v(" "),s("tr",[s("td",[t._v("/proxy_location")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server")])]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/proxy_location/my_path")])])]),t._v(" "),s("tr",[s("td",[t._v("/proxy_location")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/")])]),t._v(" "),s("td",[s("s",[s("a",{attrs:{href:"*"}},[t._v("http://server//my_path")])])])]),t._v(" "),s("tr",[s("td",[t._v("/proxy_location/")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/path")])]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/path/my_path")])])]),t._v(" "),s("tr",[s("td",[t._v("/proxy_location/")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/path/")])]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/path/my_path")])])]),t._v(" "),s("tr",[s("td",[t._v("/proxy_location")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/path")])]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/path/my_path")])])]),t._v(" "),s("tr",[s("td",[t._v("/proxy_location")]),t._v(" "),s("td",[s("a",{attrs:{href:"*"}},[t._v("http://server/path/")])]),t._v(" "),s("td",[s("s",[s("a",{attrs:{href:"*"}},[t._v("http://server//my_path")])])])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);